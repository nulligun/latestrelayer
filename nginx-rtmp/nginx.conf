# Load RTMP module
load_module /usr/lib/nginx/modules/ngx_rtmp_module.so;

worker_processes auto;
events {
    worker_connections 1024;
}

# RTMP configuration
rtmp {
    server {
        listen 1936;
        
        # Buffering and performance settings
        chunk_size 8192;           # Increased from 4096 for better throughput
        buflen 10s;                # 10 second server-side buffer for smooth playback
        max_message 10M;           # Handle large video frames (especially keyframes)
        
        application live {
            live on;
            record off;
            
            # GOP cache settings for smoother playback
            wait_key on;           # Wait for keyframe before starting playback
            wait_video on;         # Wait for video before starting playback
            
            # Audio/Video sync tolerance
            sync 10ms;             # Allow 10ms A/V sync difference
            
            # Allow publishing from docker network
            allow publish all;
            
            # Allow playing from anywhere
            allow play all;
            
            # Disable authentication for now
            # on_publish http://auth-service/auth;
        }
    }
}

# HTTP configuration for stats
http {
    server {
        listen 8080;
        
        location /stat {
            rtmp_stat all;
            rtmp_stat_stylesheet stat.xsl;
        }
        
        location /stat.xsl {
            root /usr/share/nginx/html;
        }
        
        location /health {
            access_log off;
            return 200 "OK\n";
            add_header Content-Type text/plain;
        }
    }
}