services:
  # ============================================================================
  # Tier 1: Core Services (start first - no streaming dependencies)
  # ============================================================================
  
  controller:
    stop_grace_period: 2s
    build:
      context: ./controller
      dockerfile: Dockerfile
    container_name: ${COMPOSE_PROJECT_NAME:-latestrelayer}-controller
    ports:
      - "${CONTROLLER_API_PORT:-8089}:8089"
      - "${CONTROLLER_WS_PORT:-8090}:8090"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ${APP_FOLDER}:/app:rw
      - ${SHARED_FOLDER}:/app/shared:rw
    environment:
      - COMPOSE_PROJECT_NAME=${COMPOSE_PROJECT_NAME:-latestrelayer}
      - PROJECT_PATH=/app
      - SRT_DOMAIN=${SRT_DOMAIN:-localhost}
      - SRT_PORT=${SRT_PORT:-1937}
      - MULTIPLEXER_URL=http://multiplexer:8091
    networks:
      - tsnet
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8089/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  dashboard:
    stop_grace_period: 2s
    build:
      context: ./dashboard
      dockerfile: Dockerfile
    container_name: ${COMPOSE_PROJECT_NAME:-latestrelayer}-dashboard
    depends_on:
      controller:
        condition: service_healthy
    volumes:
      - /proc/net/dev:/host_proc/net/dev:ro
      - ${SHARED_FOLDER}:/app/shared:rw
    environment:
      - PORT=3000
      - CONTROLLER_API=http://controller:8089
      - MUXER_API=http://multiplexer:8091
      - NGINX_STATS=http://nginx-rtmp:8080/stat
      - POLLING_INTERVAL=${DASHBOARD_POLLING_INTERVAL:-2000}
      - SRT_PORT=${SRT_PORT:-1937}
      - SRT_DOMAIN=${SRT_DOMAIN:-localhost}
      - KICK_URL=${KICK_URL:-}
      - KICK_KEY=${KICK_KEY:-}
    networks:
      - tsnet
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  nginx-proxy:
    stop_grace_period: 2s
    build:
      context: ./nginx-proxy
      dockerfile: Dockerfile
    container_name: ${COMPOSE_PROJECT_NAME:-latestrelayer}-nginx-proxy
    depends_on:
      dashboard:
        condition: service_healthy
    ports:
      - "443:443"
    volumes:
      - ${SHARED_FOLDER}/ssl:/etc/nginx/ssl
    environment:
      - NGINX_USER=${NGINX_USER:-admin}
      - NGINX_PASSWORD=${NGINX_PASSWORD:-changeme}
    networks:
      - tsnet
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "/usr/local/bin/health-check.sh"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================================
  # Tier 2: Streaming Infrastructure (requires controller)
  # ============================================================================

  nginx-rtmp:
    stop_grace_period: 2s
    build:
      context: .
      dockerfile: nginx-rtmp/Dockerfile
    container_name: nginx-rtmp-server
    depends_on:
      controller:
        condition: service_healthy
    volumes:
      - ./nginx.conf.template:/etc/nginx/nginx.conf.template:ro
      - ./nginx-start.sh:/usr/local/bin/nginx-start.sh:ro
    environment:
      - HLS_FRAGMENT_SIZE=${HLS_FRAGMENT_SIZE:-3}
    ports:
      - "1935:1935"    # RTMP
      - "8080:8080"    # HTTP/HLS
    networks:
      - tsnet
    restart: unless-stopped
    entrypoint: ["/bin/bash", "/usr/local/bin/nginx-start.sh"]
    healthcheck:
      test: ["CMD", "/usr/local/bin/health-check.sh"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================================
  # Tier 3: Multiplexer (requires nginx-rtmp and controller)
  # ============================================================================

  multiplexer:
    stop_grace_period: 2s
    build:
      context: .
      dockerfile: docker/Dockerfile.multiplexer
    container_name: ts-multiplexer
    depends_on:
      nginx-rtmp:
        condition: service_healthy
      controller:
        condition: service_healthy
    volumes:
      - ./config.yaml:/app/config.yaml:ro
      - ./src:/app/src:ro
      - ./CMakeLists.txt:/app/CMakeLists.txt:ro
      - ${SHARED_FOLDER}:/app/shared:rw
      - ${SHARED_FOLDER}/multiplexer-build:/app/build
      - ${SHARED_FOLDER}/tsduck-src:/opt/tsduck-src
      - ${SHARED_FOLDER}/tsduck-build:/opt/tsduck-build
      - ${SHARED_FOLDER}/tsduck:/opt/tsduck
    environment:
      - UDP_RCVBUF_SIZE=${UDP_RCVBUF_SIZE:-262144}
      - TS_QUEUE_SIZE=${TS_QUEUE_SIZE:-5000}
      - RTMP_PACING_US=${RTMP_PACING_US:-10}
      - MIN_CONSECUTIVE_FOR_SWITCH=${MIN_CONSECUTIVE_FOR_SWITCH:-10}
      - LIVE_IDR_TIMEOUT_MS=${LIVE_IDR_TIMEOUT_MS:-10000}
      - FALLBACK_IDR_TIMEOUT_MS=${FALLBACK_IDR_TIMEOUT_MS:-2000}
      - CONTROLLER_URL=http://controller:8089
    networks:
      - tsnet
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "/usr/local/bin/health-check.sh"]
      interval: 2s
      timeout: 5s
      retries: 15
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================================
  # Tier 3.5: FFmpeg RTMP Output (receives from multiplexer, publishes to RTMP)
  # ============================================================================
  
  ffmpeg-rtmp-output:
    stop_grace_period: 2s
    build:
      context: .
      dockerfile: docker/Dockerfile.ffmpeg-rtmp-output
    container_name: ${COMPOSE_PROJECT_NAME:-latestrelayer}-ffmpeg-rtmp-output
    depends_on:
      nginx-rtmp:
        condition: service_healthy
    environment:
      - TCP_RECV_BUFFER_SIZE=${TCP_RECV_BUFFER_SIZE:-2097152}
      - RTMP_URL=${RTMP_URL:-rtmp://nginx-rtmp/live/stream}
    networks:
      - tsnet
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "/usr/local/bin/health-check.sh"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================================
  # Tier 4: Stream Sources (will restart until they connect)
  # ============================================================================

  ffmpeg-srt-input:
    stop_grace_period: 2s
    build:
      context: .
      dockerfile: docker/Dockerfile.ffmpeg-srt-input
    container_name: ffmpeg-srt-input
    ports:
      - "1937:1937/udp"
      - "10000:10000/tcp"  # Expose TCP stream for host testing
    environment:
      - SRT_LATENCY_MS=${SRT_LATENCY_MS:-200}
      - TCP_SEND_BUFFER_SIZE=${TCP_SEND_BUFFER_SIZE:-2097152}
      - MPEGTS_MAX_DELAY=${MPEGTS_MAX_DELAY:-1000000}
      - MPEGTS_MUXRATE=${MPEGTS_MUXRATE:-5M}
    networks:
      - tsnet
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "/usr/local/bin/health-check.sh"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  ffmpeg-rtmp-input:
    stop_grace_period: 2s
    build:
      context: .
      dockerfile: docker/Dockerfile.ffmpeg-rtmp-input
    container_name: ffmpeg-rtmp-input
    depends_on:
      nginx-rtmp:
        condition: service_healthy
    ports:
      - "10002:10002/tcp"  # Expose TCP stream for host testing
    environment:
      - TCP_SEND_BUFFER_SIZE=${TCP_SEND_BUFFER_SIZE:-2097152}
      - MPEGTS_MAX_DELAY=${MPEGTS_MAX_DELAY:-1000000}
      - MPEGTS_MUXRATE=${MPEGTS_MUXRATE:-5M}
    networks:
      - tsnet
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "/usr/local/bin/health-check.sh"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  ffmpeg-fallback:
    stop_grace_period: 2s
    build:
      context: .
      dockerfile: docker/Dockerfile.ffmpeg-fallback
    container_name: ffmpeg-fallback
    ports:
      - "10001:10001/tcp"  # Expose TCP stream for host testing
    volumes:
      - ${SHARED_FOLDER}:/media:rw
    environment:
      - TCP_SEND_BUFFER_SIZE=${TCP_SEND_BUFFER_SIZE:-2097152}
      - MPEGTS_MAX_DELAY=${MPEGTS_MAX_DELAY:-1000000}
      - MPEGTS_MUXRATE=${MPEGTS_MUXRATE:-5M}
    networks:
      - tsnet
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "/usr/local/bin/health-check.sh"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================================
  # Manual/Optional Services
  # ============================================================================

  ffmpeg-kick:
    stop_grace_period: 2s
    build:
      context: .
      dockerfile: docker/Dockerfile.ffmpeg-kick
    container_name: ${COMPOSE_PROJECT_NAME:-latestrelayer}-ffmpeg-kick
    profiles:
      - manual
    depends_on:
      nginx-rtmp:
        condition: service_healthy
    volumes:
      - ${SHARED_FOLDER}:/app/shared:ro
    environment:
      - KICK_URL=${KICK_URL:-}
      - KICK_KEY=${KICK_KEY:-}
      - KICK_STREAM_URL=${KICK_STREAM_URL:-}
      - KICK_STREAM_KEY=${KICK_STREAM_KEY:-}
    networks:
      - tsnet
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "/usr/local/bin/health-check.sh"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  mock-camera:
    stop_grace_period: 2s
    build:
      context: .
      dockerfile: docker/Dockerfile.mock-camera
    container_name: mock-camera
    profiles:
      - manual
    networks:
      - tsnet
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "/usr/local/bin/health-check.sh"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  mock-drone:
    stop_grace_period: 2s
    build:
      context: .
      dockerfile: docker/Dockerfile.mock-drone
    container_name: mock-drone
    profiles:
      - manual
    depends_on:
      nginx-rtmp:
        condition: service_healthy
    networks:
      - tsnet
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "/usr/local/bin/health-check.sh"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  tsnet:
    driver: bridge
    name: tsduck-multiplexer-network
    driver_opts:
      com.docker.network.bridge.name: br-tsnet
    enable_ipv6: false
    ipam:
      driver: default
      config:
        - subnet: 172.28.0.0/16
          gateway: 172.28.0.1