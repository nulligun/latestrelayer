# Load RTMP module
load_module /usr/lib/nginx/modules/ngx_rtmp_module.so;

worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

# RTMP configuration
rtmp {
    server {
        listen 1935;
        chunk_size 4096;
        
        application live {
            live on;
            record off;
            
            # Allow publishing from any source
            allow publish all;
            
            # Don't allow playback (this is just an ingest point)
            deny play all;
            
            # Increase buffer for smooth streaming
            wait_video on;
            wait_key on;
            
            # Drop idle publishers after 10 seconds
            drop_idle_publisher 10s;
            
            # Sync audio and video
            sync 10ms;
            
            # Set buffer size
            buffer 3s;
        }
        
        application offline {
            live on;
            record off;
            
            # Only allow local publishing (from switcher container)
            allow publish 127.0.0.1;
            deny publish all;
            
            # Drop idle publishers quickly
            drop_idle_publisher 5s;
        }
        
        application switch {
            live on;
            record off;
            
            # Only allow local publishing (from switcher container)
            allow publish 127.0.0.1;
            deny publish all;
            
            # This is the canonical stream that push-to-kick pulls from
            drop_idle_publisher 5s;
        }
    }
}

# HTTP server for stats
http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    access_log /var/log/nginx/access.log;
    
    server {
        listen 8080;
        
        # RTMP statistics in XML format
        location /rtmp_stat {
            rtmp_stat all;
            rtmp_stat_stylesheet stat.xsl;
            add_header Access-Control-Allow-Origin *;
        }
        
        location /stat.xsl {
            root /etc/nginx/;
        }
        
        # Health check endpoint
        location /health {
            access_log off;
            return 200 "OK\n";
            add_header Content-Type text/plain;
        }
    }
}